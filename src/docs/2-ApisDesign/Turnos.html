<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/docPage.css">
    <link rel="stylesheet" href="../css/docs.css">
    <title>Turnos API REST</title>
</head>

<body>
    <div id="main-title">
        <h1>MateStampa Docs</h1>
    </div>


    <div id="grupo-documento">
        <!-- Enlace al grupo -->
        <a id="grupo-enlace" href="../../Intros/2 apis_design.html">Apis Design</a>
        <!-- Separador ">" -->
        <span> &gt; </span>
        <!-- Enlace al documento -->
        <a>Turnos API REST</a>
    </div>

    <div id="show-doc-container">
        <div id="indice"><ul class="indice"><li><a class="h1-ref" href="#INTRO:">INTRO:</a></li><li><a class="h1-ref" href="#REQUERIMIENTOS FUNCIONALES:">REQUERIMIENTOS FUNCIONALES:</a></li><li><a class="h1-ref" href="#TÉCNICA DE SISTEMA DE TURNOS IMPLEMENTADA:">TÉCNICA DE SISTEMA DE TURNOS IMPLEMENTADA:</a></li><li><a class="h1-ref" href="#DB DESIGN:">DB DESIGN:</a></li><ul class="nivel-h2"><li><a class="h2-ref" href="#"></a></li><li><a class="h2-ref" href="#"></a></li><li><a class="h2-ref" href="#Explicación de tablas:">Explicación de tablas:</a></li><li><a class="h2-ref" href="#Indexes:">Indexes:</a></li><li><a class="h2-ref" href="#Decisiones del diseño:">Decisiones del diseño:</a></li></ul><li><a class="h1-ref" href="#ENDPOINTS:">ENDPOINTS:</a></li><li><a class="h1-ref" href="#EXPLICACION DE ENDPOINTS IMPORTANTES:">EXPLICACION DE ENDPOINTS IMPORTANTES:</a></li><li><a class="h1-ref" href="#EXPLICACIÓN DE CIERTAS IMPLEMENTACIONES:">EXPLICACIÓN DE CIERTAS IMPLEMENTACIONES:</a></li><ul class="nivel-h2"><li><a class="h2-ref" href="#1-Transaction segura al tomar turno:">1-Transaction segura al tomar turno:</a></li><li><a class="h2-ref" href="#2-Manejo de límite de días a futuro:">2-Manejo de límite de días a futuro:</a></li><li><a class="h2-ref" href="#3-Insercion de “day_time” rows a la BBDD:">3-Insercion de “day_time” rows a la BBDD:</a></li></ul><li><a class="h1-ref" href="#FUNCIONALIDADES NO IMPLEMENTADAS:">FUNCIONALIDADES NO IMPLEMENTADAS:</a></li><ul class="nivel-h2"><li><a class="h2-ref" href="#2-Cómo esperar al user que pague, para confirmar la reserva de su turno:">2-Cómo esperar al user que pague, para confirmar la reserva de su turno:</a></li></ul></ul></div>

        <div id="contenedor-documento">
            <div id="documento"><div id="A" style="background-color: transparent; min-height: 1000px; width: 100%; padding-top: 20px; overflow: auto;"><style></style><section style="width: 793px; min-height: 1122px; padding: 94px 113px; column-gap: 48px;"><p class=" Normal" style="text-align: center;"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 0); font-size: 26px;">    “Take turnos” API REST</span></p><details class="display-section" id="INTRO:"><summary class="Ttulo1">INTRO:</summary><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Una api para una pagina, o app, para tomar turnos. En este caso los turnos son para acceder a algún lugar, como un parque, una pista de autos, etc. Donde se quiere asegurar que haya solo cierta cantidad de gente en un día y horario. Es decir, cada día tien</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">e ciertas horas disponibles, y por cada hora hay varios espacios. </span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Por ahora es gratis tomar el turno, por lo que no hay ninguna consideración implementada con respecto al pago y demás.</span></p><p class=" Normal"></p></details><details class="display-section" id="REQUERIMIENTOS FUNCIONALES:"><summary class="Ttulo1">REQUERIMIENTOS FUNCIONALES:</summary><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">1-Ver días más próximos disponibles.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">2-Ve</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">r horas dentro del día disponibles.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">3-Tomar un turno:</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter">      </span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);"> -Hasta cierto tiempo de días en el futuro. </span><span class=" Fuentedeprrafopredeter" style="color: rgb(0, 230, 104); font-size: 17px; background-color: darkblue;">VER</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255); font-size: 17px; background-color: darkblue;"> </span><span class=" Fuentedeprrafopredeter" style="color: rgb(9, 255, 120); font-size: 17px; background-color: darkblue;">IMPLEMENTACIONES(2)</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">4-Cancelar un turno:</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">       -Debe ser con cierto tiempo de antelación.</span></p><p class=" Normal"></p></details><details class="display-section" id="TÉCNICA DE SISTEMA DE TURNOS IMPLEMENTADA:"><summary class="Ttulo1">TÉCNICA DE SISTEMA DE TURNOS IMPLEMENTADA:</summary><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Ver:</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255); font-size: 18px;"> </span><a href="../docs/3-CaseStudies/SistTurnosBBDD.html"><span class=" Fuentedeprrafopredeter" style="color: rgb(17, 85, 204); font-size: 18px; text-decoration: underline;">../docs/3-CaseStudies/SistTurnosBBDD.html</span></a></p><p class=" Normal"></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Usamos la técnica de: </span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 192, 0);">“Sin previo llenado”</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);"> y con “</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 192, 0);">Sistema de niveles”</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);"> </span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 192, 0);">“Con repetición posible”</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">. </span></p><p class=" Normal" id="_heading=h.30j0zll"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">En este caso particular tenemos varios días disponibles, dentro de los cuales hay horarios disponibles. Que a su vez cada uno tiene ciertos espacios disponibles.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">-Osea los niveles que tenemos son : DIAS - HORAS- SPACES</span></p><p class=" Normal" id="_heading=h.1fob9te"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">-En nuestras tablas de db sería : day</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">s - day_time</span></p><p class=" Normal" id="_heading=h.gjdgxs"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">En cada nivel de datos de turno (o en las tablas en realidad) ,se pone un avail (cantidad de espacios disponibles). Para tomar un turno, siempre se resta primero el “avail” del nivel más bajo. Y si ese “avail” llega a 0, debe restarse también </span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">el “avail” de su nivel superior.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Lo único necesario para traer los disponibles de cada cosa, es chequear que “avail” &gt; 0.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Eso sí, hay que mantener todo actualizado cada vez que se toma un turno.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">En este caso tomar un space reduce “avail” de un day_time; y </span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">reducir el “avail” de un day_time (a 0) reduce el “avail” de un día.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Este sistema da unos reads más rápidos, al momento de consultar los días/horas disponibles; pero hace que los writes sean más lentos, ya que en ciertos casos hay que actualizar varias tab</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">las. Pero nuestra prioridad es la velocidad al ver los turnos disponibles. </span></p><p class=" Normal"></p></details><details class="display-section" id="DB DESIGN:"><summary class="Ttulo1">DB DESIGN:</summary><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">IFRAME</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(9, 255, 120); font-size: 21px;"><iframe src="https://drawsql.app/teams/los-colos/diagrams/turnos/embed" width="100%" height="300px"></iframe></span></p><h2 class=" Normal Ttulo2" id=""></h2><h2 class=" Normal Ttulo2" id=""></h2><h2 class=" Normal Ttulo2" id="Explicación de tablas:"><span class=" Fuentedeprrafopredeter" style="font-weight: 700; color: rgb(255, 192, 0); font-size: 21px; text-decoration: underline;">Explicación de tablas:</span></h2><h3 class=" Normal Ttulo3" id="_heading=h.86pod7jt4w1r"><span class=" Fuentedeprrafopredeter" style="font-weight: 700; color: rgb(0, 176, 240);">hours()</span></h3><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Contiene las horas que habrá disponibles todos los días.</span></p><h3 class=" Normal Ttulo3" id="_heading=h.71doukrqqxza"><span class=" Fuentedeprrafopredeter" style="font-weight: 700; color: rgb(0, 176, 240);">days()</span></h3><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Contiene los días del año, y un campo “avail” para saber cuantas horas disponibles le quedan. (y de esa manera ver si esta disponible el dia)</span></p><h3 class=" Normal Ttulo3" id="_heading=h.1jc0vpwu8c31"><span class=" Fuentedeprrafopredeter" style="font-weight: 700; color: rgb(0, 176, 240);">day_time()</span></h3><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Vincula un dia con una hora, y tiene un campo “avail” para saber cuantos espacios disponibles le quedan</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);"> a ese “combo”. (y de esa manera ver si esta disponible la hora de ese dia)</span></p><h3 class=" Normal Ttulo3" id="_heading=h.elq1vpqsra2x"><span class=" Fuentedeprrafopredeter" style="font-weight: 700; color: rgb(0, 176, 240);">turnos()</span></h3><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Registro de los turnos ya tomados.</span></p><h2 class=" Normal Ttulo2" id="Indexes:"><span class=" Fuentedeprrafopredeter" style="font-weight: 700; color: rgb(255, 192, 0); font-size: 21px; text-decoration: underline;">Indexes:</span></h2><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255); font-size: 16px;">Simplemente dejamos los predeterminados en la pks de las tablas. No necesitamos más debido a las tipos de querys que tenemos.</span></p><h2 class=" Normal Ttulo2" id="Decisiones del diseño:"><span class=" Fuentedeprrafopredeter" style="font-weight: 700; color: rgb(255, 192, 0); font-size: 21px; text-decoration: underline;">D</span><span class=" Fuentedeprrafopredeter" style="font-weight: 700; color: rgb(255, 192, 0); font-size: 21px; text-decoration: underline;">ecisiones del diseño:</span></h2><h3 class=" Normal Ttulo3" id="_heading=h.2zmg52kig7s6"><span class=" Fuentedeprrafopredeter" style="font-weight: 700; color: rgb(0, 176, 240);">-Por que guardamos las horas así?:</span></h3><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Osea por que ponemos el id, y no la hora directa en la tabla “day_time”?: De esta manera si el admin quiere cambiar la hora por casualidad, solo debe tocar la tabla “hours”, y nada en “day_time”. (A </span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">menos que quiera agregar mas o sacar horarios). </span></p><p class=" Normal"></p></details><details class="display-section" id="ENDPOINTS:"><summary class="Ttulo1">ENDPOINTS:</summary><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Los marcados con un </span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255); background-color: red;">número,</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);"> son de una complejidad más alta que el resto y requieren una explicación extra.</span></p><table class=" TableNormal0 a0" id="A0" x0="1" x1="1" x2="1" x3="1" x4="1" x5="1" x6="1" x7="1" x8="1" x9="1" x10="1" x11="1" style="width: 566px;"><colgroup><col style="width:33.51063829787234%"><col style="width:22.872340425531913%"><col style="width:22.163120567375888%"><col style="width:21.45390070921986%"></colgroup><tbody><tr><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Endpoint</span></p></td><td style="background-color: rgb(0, 0, 0);"><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Args</span></p></td><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Return</span></p></td><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Descr</span></p></td></tr><tr><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">GET “user/login”</span></p></td><td style="background-color: rgb(0, 0, 0);"><p class=" Normal"></p></td><td><p class=" Normal"></p></td><td><p class=" Normal"></p></td></tr><tr><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">POST “user/login”</span></p></td><td style="background-color: rgb(0, 0, 0);"><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">username: text,</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">password: text</span></p></td><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Setea Cookies:</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">sessionId,</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">user_id</span></p></td><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Proceso de login</span></p></td></tr><tr><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">GET “user/logout”</span></p></td><td style="background-color: rgb(0, 0, 0);"><p class=" Normal"></p></td><td><p class=" Normal"></p></td><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Cierra la session</span></p></td></tr><tr><td style="background-color: rgb(255, 255, 255);"><p class=" Normal"></p></td><td style="background-color: rgb(255, 255, 255);"><p class=" Normal"></p></td><td style="background-color: rgb(255, 255, 255);"><p class=" Normal"></p></td><td style="background-color: rgb(255, 255, 255);"><p class=" Normal"></p></td></tr><tr><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">GET “turnos/avail_days”</span></p></td><td style="background-color: rgb(0, 0, 0);"><p class=" Normal"></p></td><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Array{</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">day: date,</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">avail: int }</span></p></td><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Trae días disponibles</span></p></td></tr><tr><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">GET “turnos/avail_hours/:day_id”</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255); background-color: red;">2)</span></p></td><td style="background-color: rgb(0, 0, 0);"><p class=" Normal"></p></td><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Array{</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">day_time_id: int,</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">hour: string,</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">avail: int }</span></p></td><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Trae horarios disponibles de un día</span></p></td></tr><tr><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">POST “turnos/save”</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255); background-color: red;">3)</span></p></td><td style="background-color: rgb(0, 0, 0);"><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">day_time_Id: int</span></p></td><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">turno_id: int</span></p></td><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Reserva un turno</span></p></td></tr><tr><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">PUT “turnos/cancel”</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255); background-color: red;">4)</span></p></td><td style="background-color: rgb(0, 0, 0);"><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">turno_id: int</span></p></td><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">cancelled: bool</span></p></td><td><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Cancela un turno</span></p></td></tr></tbody></table><p class=" Normal"></p><p class=" Normal"></p></details><details class="display-section" id="EXPLICACION DE ENDPOINTS IMPORTANTES:"><summary class="Ttulo1">EXPLICACION DE ENDPOINTS IMPORTANTES:</summary><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255); background-color: red;">2-------------)</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(0, 176, 240);">Hint frontend</span><span class=" Fuentedeprrafopredeter">:</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);"> el arg: “day_id”(que es el día) debe mandarse en formato “{year}-{month}-{day}” (un string sin horario ni nada).</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255); background-color: red;">3------------)</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Al momento de tomar un turno para cierto día y hora (osea un “day_time”) se verifica primero que exista el “day_time_id” con la</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);"> bbdd y que tampoco sea mayor al dia limite.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Luego de eso se verifica que le queden espacios al “day_time” (la columna “avail”).  Haciendo un “Exclusive lock” en la row de la tabla “day_time” con un “SELECT FOR UPDATE”. Esto para que no se de un “double bo</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">oking”. </span><span class=" Fuentedeprrafopredeter" style="color: rgb(9, 255, 120); font-size: 17px; background-color: darkblue;">VER IMPLEMENTACIONES(1)</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Aca se empezaría la transacción: </span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Si “avail” es 0 se hace rollback de la transacción y se termina la request.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Si “avail” es &gt;0 entonces se sigue con la transaction:</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">    -Se inserta una row a “turnos” con el day_time_id y use</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">r correspondiente.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">    -update -1 el “avail” de la row de “day_time”</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">    -update -1 el “avail” de la row de “days” correspondiente ( SI ES QUE EL DE “day_time” QUEDO EN 0)</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Con los primeros controles, más la transaction, evitamos que se tomen más turnos de </span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">los disponibles, y que se inserten días u horarios prohibidos.</span></p><p class=" Normal"></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255); background-color: red;">4----------)</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Se verifica primero que la cancelación se de dentro del límite de días contemplado hasta el día del turno.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Para cancelar se hace una transaction:</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">   -Borrar la row correspondiente</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);"> de “turnos”</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">   -update +1 el “avail” de la row de “day_time”</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">   -update +1 el “avail” de la row de “days” correspondiente ( SI ES QUE EL DE  “day_time” ESTABA EN 0)</span></p><p class=" Normal"></p></details><details class="display-section" id="EXPLICACIÓN DE CIERTAS IMPLEMENTACIONES:"><summary class="Ttulo1">EXPLICACIÓN DE CIERTAS IMPLEMENTACIONES:</summary><h2 class=" Normal Ttulo2" id="1-Transaction segura al tomar turno:"><span class=" Fuentedeprrafopredeter" style="font-weight: 700; color: rgb(255, 192, 0); font-size: 21px; text-decoration: underline;">1-Transaction segura al tomar turno:</span></h2><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Lo hacemos </span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">con un “exclusive lock”, haciendo “SELECT FOR UPDATE” en una row de la tabla “day_time”:</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">-Ahí ya nadie va a poder acceder a ese “day_time”(por más que queden 20 espacios). Osea si llegan 2 users muy pegados que quieren el mismo “day_time”, el que llegue má</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">s tarde va a tener q esperar que se libere la row; y ahí recién va a poder leer lo q dice el “avail”, proceder luego.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">-Aunque queden 20 espacios (y parezca que estamos bloqueando al pedo), es importante que se haga  un "exclusive lock" y no un "share lock"</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">. Porque si hacemos un "share lock" y permitimos que lea y siga con la transaction; si entraron 2 muy pegadas, y justo queda 1 espacio solo; por mas que la q entro mas tarde no pueda hacer write(por un tiempo), lo va a terminar haciendo y va a quedar el av</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">ail en -1 (y se habrán sacado turnos de más). O en su defecto también podría quedar en 0 pero los turnos se asignan a las 2 personas, y habría más gente de la permitida.</span></p><h2 class=" Normal Ttulo2" id="2-Manejo de límite de días a futuro:"><span class=" Fuentedeprrafopredeter" style="font-weight: 700; color: rgb(255, 192, 0); font-size: 21px; text-decoration: underline;">2-Manejo de límite de días a futuro:</span></h2><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">-Mantenemos en el server una variable constante, </span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">con el límite  de días a futuro (para tomar turno), y generamos internamente la fecha actual y la fecha límite. Esta generación la repetimos al principio de cada día con un scheduler.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">(así no tenemos que calcular la fecha_limite en cada llamado de endpoint</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">).</span></p><h2 class=" Normal Ttulo2" id="3-Insercion de “day_time” rows a la BBDD:"><span class=" Fuentedeprrafopredeter" style="font-weight: 700; color: rgb(255, 192, 0); font-size: 21px; text-decoration: underline;">3-Insercion de “day_time” rows a la BBDD:</span></h2><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Vamos metiendo los correspondientes de cada día con un scheduler al inicio de cada dia</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Por que hacemos esto, y no metemos, por ejemplo, todos los de un año de una?:</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">-Si llegado al caso llegan a cambiar las horas, ya sea por cantidad o por cuales se usen; No tenemos que actualizar toda la tabla, ya que las rows que se metan en el dia ya van a</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);"> tener la nueva configuración. (Aunque igualmente si deberíamos modificar toda la tabla entre los limit_days).</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">-Lo que si usando esta opción, debemos primero, cuando se inicia el server x primera vez, meter todos los que estén entre los “limit_days” de una</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">. Y después, ya luego del 1er día ahí se van metiendo de a 1.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Igualmente esta opción puede utilizarse o no dependiendo de: si sabemos que los horarios van a cambiar seguido, o calculando si updatear la tabla completa (en caso de que metamos todos de una) t</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">arda mucho o no se siente.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">Por ejemplo en el caso de las rows de la tabla “days”, los metemos todos de una, ya que es raro que cambien los días.</span></p><p class=" Normal"></p></details><details class="display-section" id="FUNCIONALIDADES NO IMPLEMENTADAS:"><summary class="Ttulo1">FUNCIONALIDADES NO IMPLEMENTADAS:</summary><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 192, 0); font-size: 16px;">1-Endpoints de admin, para modificar las distintas reglas para tomar los tur</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 192, 0); font-size: 16px;">nos, o cambiar horarios o días.</span></p><h2 class=" Normal Ttulo2" id="2-Cómo esperar al user que pague, para confirmar la reserva de su turno:"><span class=" Fuentedeprrafopredeter" style="font-weight: 700; color: rgb(255, 192, 0); font-size: 21px; text-decoration: underline;">2-Cómo esperar al user que pague, para confirmar la reserva de su turno:</span></h2><h3 class=" Normal Ttulo3" id="_heading=h.3w9gy9z3vjeq"><span class=" Fuentedeprrafopredeter" style="font-weight: 700; color: rgb(0, 176, 240);">Approach basico:</span></h3><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">En este caso, la toma del turno sería si o si con pago.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">-Usamos una tabla "to_confirm" (id, user_id, day_time_id, taken_at) donde mete</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">mos un “day_time_id” cuando un user lo elige(antes de pagar):</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);"> -Le ponemos un day_time_id que refiere a la tabla “day_time” y un "taken_at" que es el momento donde se tomó.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">-Le damos x tiempo al user para pagar(se lo podemos mostrar en el front)</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">-Cuando ha</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">ce el pago, se chequea que salga todo bien y ahi si se agrega a la tabla "turnos" posta y luego se manda un mail,o lo que sea.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);"> -Si algo sale mal, o el scheduler(que mencionaremos mas abajo) lo borro antes, se debería devolver la plata.</span></p><p class=" Normal"><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">-Mientras tanto sie</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">mpre está corriendo por detrás un scheduler que,cada x tiempo, chequea que las rows en "to_confirm" no se hayan pasado de tiempo (con el "taken_at"). Las que se pasaron, se encarga de volver atrás todo lo que implicó tomar el turno. Osea aumentar la dispon</span><span class=" Fuentedeprrafopredeter" style="color: rgb(255, 255, 255);">ibilidad en "day_time" y si es necesario en "days"; y por último elimina la row de "to_confirm"</span></p><p class=" Normal"></p><p class=" Normal"></p><p class=" Normal"></p></details></section></div></div>
        </div>

        <div id="espacio-derecha"></div>

    </div>

</body>
</html>